## Presentation

As we were developing the BCI, we found it necessary to develop another User Interface which simulates Intan live acquisition from recorded LFP signals, and which performs Sleep Scoring and Delta Detection. It allowed us to test algorithms that we wanted to implement on the BCI, without having to do a recording session. As the Online Simulation Interface also generates Delta detections matrix, we were also able to compare these results with offline detections (check the next chapter to see these comparisons).

This Interface can be useful to develop new functions, test Machine Learning classifiers or just to replay signals after an experiment.

Here is how the Interface looks like:
![](https://user-images.githubusercontent.com/41677251/43520501-5d61e746-9593-11e8-97c0-b8249fc95ddf.png)

## Getting Started 

The two first things to do are to Load Signals and do the Pre-Processing, with the two Menu buttons on the top-left of the interface.

![](https://user-images.githubusercontent.com/41677251/43575823-138d32be-9648-11e8-85d9-c199b531ef01.png)

* **Load Signals**

When you click **Load** Button, first select the acquisition directory containing LFP files you want to read:

![](https://user-images.githubusercontent.com/41677251/43585162-ae632b7e-9664-11e8-8442-23430e984fb2.png)

Then, select the corresponding -.csv- parameters file:

![](https://user-images.githubusercontent.com/41677251/43585227-e5b7fb54-9664-11e8-92e2-3ee5befecd7a.png)

**_Load.m_** function will convert _.tsd objects_ in _.mat_ files, determine the sampling frequency and create take the acquisition time stamps to create a time vector.

* **Pre-Processing**

**_PreProcessing.m_** function first downsamples signals from the sampling frequency of LFPs generated by ndm_manager (generally 1250Hz) to 312.5 Hz. We chose 312.5 Hz because it is the closest sampling frequency to 333.33 Hz (sampling frequency at which **_read_continuously.m_** downsamples the 20 kHz raw signal coming from Intan to do its processing) that we can rich with a fixed DataBlock size.

Gamma (OB), Theta and Delta (HPC) signals are filtered with _bandpass_ Matlab filters. 

Then the function computes parameters that optimize Delta Detection: **multiplicative prefactors** for PFCdeep and PFCsup and **Delta Threshold**. To compute these parameters we only keep non noisy SWS Signals. Prefactors multiplication aims to make the PFC sup and PFC deep signals look similar when there is no Delta. PFC deep prefactor is set to 1 and sup prefactor is equal to the ratio of the PFC deep variance over PFC sup variance. Delta threshold equals two times the std of filtered difference (PFC deep - PFC deep). Here is the code :

--> Loading Epochs generated by **_SleepScoringOBGamma.m_**

`load(strcat(Signals.dname,'/Processed/SleepScoring_OBGamma.mat'),'SWSEpoch','TotalNoiseEpoch','Epoch');`

--> Epoch corresponding to SWS sleep without the noise 

`TS = and(Epoch-TotalNoiseEpoch,SWSEpoch);`

--> Selecting SWS Sleep without Noise Epoch

`Signals.S.S3.PFCsup_LFP_SWS = Restrict(Signals.S.S3.PFCsup_LFP,TS);`

`Signals.S.S3.PFCdeep_LFP_SWS = Restrict(Signals.S.S3.PFCdeep_LFP,TS);`

--> Computing Variances

`var_sup = var(Data(Signals.S.S3.PFCsup_LFP_SWS));`

`var_deep = var(Data(Signals.S.S3.PFCdeep_LFP_SWS));`

--> Computing Prefators

`Signals.deep_prefactor = 1;`
`Signals.sup_prefactor = var_deep/var_sup;`
`%Setting Prefactors in the Interface `
`set(Interface.Sup_prefactor_edit,'String',num2str(Signals.sup_prefactor));`
`set(Interface.Deep_prefactor_edit,'String',num2str(Signals.deep_prefactor));`

--> Computing PFCdeep _ PFCsup with prefactors 

`diff_temp = Data(Signals.S.S3.PFCdeep_LFP_SWS) - Signals.sup_prefactor * Data(Signals.S.S3.PFCsup_LFP_SWS);                                 `

--> Filtering

`b = fir1(1024,[1 12]*(2/Signals.fs));`
`diff_temp_filtered = filtfilt(b,1,diff_temp);`

--> Selecting positive values

`pos_diff_temp = max(diff_temp_filtered,0);`

--> Computing std that determines threshold

`std_diff = std(pos_diff_temp(pos_diff_temp>0));                            `
`Signals.delta_treshold = 2 * std_diff * 0.195e-3;`


## Functionalities

* **Lecture Controls Panel** 
* **Sleep Scoring Panel**
* **Delta Detection Panel**

## Results

## Faster Simulation without display   